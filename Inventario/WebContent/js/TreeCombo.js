Ext.ux.TreeCombo=Ext.extend(Ext.form.SelectBox,{lastKeys:"",admitLeaf:true,treeTypeAhead:false,initComponent:function(){Ext.ux.TreeCombo.superclass.initComponent.call(this)},initList:function(){if(this.list!=undefined){return}if(this.editable!==false){this.el.on("keyup",this.onKeyUpTree,this)}if(this.treeTypeAhead){this.taTask=new Ext.util.DelayedTask(this.onTreeTypeAhead,this)}var a={floating:true,listeners:{click:this.onNodeClick,scope:this},alignTo:function(c,d){this.setPagePosition(this.el.getAlignToXY(c,d))},keys:[{key:9,fn:function(){this.onNodeClick(this.list.getSelectionModel().getSelectedNode())},scope:this},{key:27,fn:function(){this.collapse();this.focus(true,true)},scope:this}]};if(this.treeConfig){Ext.applyIf(a,this.treeConfig);if(this.treeConfig.listeners){Ext.applyIf(a.listeners,this.treeConfig.listeners)}if(a.loader){a.loader.on("load",this.onTreeLoad,this)}}this.list=new Ext.tree.TreePanel(a);if(!this.list.rendered){var b=this.listWidth||Math.max(this.wrap.getWidth(),this.minListWidth);this.list.render(document.body);this.list.setWidth(b);this.list.alignTo(this.wrap,this.listAlign);this.innerList=this.list.body;this.innerList.setWidth(b);this.innerList.setWidth(b-this.list.getFrameWidth("lr"));this.list.hide()}},doQuery:function(b,a){this.expand()},collapseIf:function(a){if(!a.within(this.wrap)&&!a.within(this.list.el)){this.collapse()}},selectNext:function(){var a=this.list.getSelectionModel();if(!a.getSelectedNode()){a.select(this.list.getRootNode())}a.selectNext()},selectPrev:function(){var a=this.list.getSelectionModel();if(!a.getSelectedNode()){a.select(this.list.getRootNode())}a.selectPrevious()},onViewClick:function(a){this.collapse();if(a!==false){this.el.focus()}},findNode:function(d,c,a,b){var e=this;if(c==null||c==undefined){c=e.list.getRootNode()}var d=d;if(c.isLoaded()==true){if(c.childNodes.length>0){e.nodeFound=c.findChild("path",d);if(e.nodeFound==null||e.nodeFound==undefined){c.cascade(function(){if(this.text==d){if((this.getPath("text")==a)||(a==null)){e.nodeFound=this}}else{if(b==true){var g=this.text;var f=g.indexOf(d);if(f>=0){e.nodeFound=this}}}if(e.nodeFound!=null&&e.nodeFound!=undefined){return false}})}}}else{e.list.getLoader().load(c,function(f,i,g,h){i.loaded=true;e.nodeFound=e.findNode(d,i,g,h)})}return e.nodeFound},setValue:function(f,d){if(this.list==undefined){this.initList()}if(f==""){this.setRawValue("");return}this.el.removeClass(this.emptyClass);var b=this.findNode(f,null,d,null);if(b!=null&&b!=undefined){text=b.attributes.path;if(text.length==0){text=(!empty(this.value)?this.value:"")}if((b.isLeaf()==false)&&(this.admitLeaf==false)){return}var c=b.getPath();var a=this.list.getRootNode();a.reload();this.list.expandPath(c);this.list.selectPath(c);this.setRawValue(text);if(this.hiddenField){this.hiddenField.value=f}}else{this.setRawValue();var e=this.list.getRootNode();e.reload();this.list.collapseAll()}},setValueFromNode:function(a){this.setRawValue(a.attributes.path);if(this.hiddenField){this.hiddenField.value=a.id}},openCombo:function(){this.onTriggerClick()},onTreeTypeAhead:function(){var f=this.getRawValue();var g=this.getRawValue().length;if(g<=0){this.setRawValue("");var e=this.list.getRootNode();e.reload();this.list.collapseAll();return}var c=this.findNode(f,null,null,true);if(c!=null&&c!=undefined){text=c.attributes.path;var a=text.length;if(g!=a){if((c.isLeaf()==false)&&(this.admitLeaf==false)){return}var d=c.getPath();var b=this.list.getRootNode();b.reload();this.list.expandPath(d);this.list.selectPath(d);this.setRawValue(text);this.selectText(g,text.length);if(this.hiddenField){this.hiddenField.value=f}this.focus.defer(10,this)}}},onKeyUpTree:function(a){if(this.editable!==false&&!a.isSpecialKey()){this.lastKeys=a.getKey();if(this.treeTypeAhead&&(this.lastKeys==Ext.EventObject.BACKSPACE||this.lastKeys==Ext.EventObject.DELETE)){this.taTask.delay();return}if(this.treeTypeAhead){this.onTreeTypeAhead()}}},onNodeClick:function(b,c){if((b.isLeaf()==false)&&(this.admitLeaf==false)){return}var a=this.getValue();this.setValueFromNode(b);this.collapse();if(this.treeTypeAhead){this.focus(true,false)}else{this.focus(false,false)}this.fireEvent("select",this,a,this.getValue());this.fireEvent("change",this,b);this.fireEvent("rootchanged",b)},onTreeLoad:function(a,c,b){this.list.expandAll();this.list.collapseAll();if(this.list.getRootNode()==c){if(this.hiddenField&&this.hiddenField.value&&this.hiddenField.value!=""){var d=this.list.getNodeById(this.hiddenField.value);if(d){d.select();this.setRawValue(d.attributes.path)}else{this.list.getSelectionModel().clearSelections();this.setRawValue("");this.hiddenField.value=""}}}}});Ext.reg("treecombo",Ext.ux.TreeCombo);